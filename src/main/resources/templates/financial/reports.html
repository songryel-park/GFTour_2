<!DOCTYPE html>
<html lang="ko" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      th:replace="~{layout/base :: html}">
<head>
    <meta charset="UTF-8">
    <title>정산보고서 - Good Feel Tour</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts - Noto Sans KR -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div th:block="content">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="gf-secondary mb-0">
                            <i class="fas fa-chart-line me-2"></i>정산보고서
                        </h2>
                    </div>
                    <div>
                        <button type="button" class="btn btn-outline-success me-2" id="exportReport">
                            <i class="fas fa-file-excel me-2"></i>Excel 내보내기
                        </button>
                        <button type="button" class="btn btn-gf-primary" data-bs-toggle="modal" data-bs-target="#calculatorModal">
                            <i class="fas fa-calculator me-2"></i>수수료 계산
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Summary Cards -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-success bg-opacity-10 d-flex align-items-center justify-content-center me-3" 
                                 style="width: 50px; height: 50px;">
                                <i class="fas fa-arrow-down text-success fa-lg"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">수취송금합계(W)</h6>
                                <h4 class="mb-0 text-success">₩15,500,000</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center me-3" 
                                 style="width: 50px; height: 50px;">
                                <i class="fas fa-arrow-up text-primary fa-lg"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">판매송금합계(W)</h6>
                                <h4 class="mb-0 text-primary">₩18,200,000</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-warning bg-opacity-10 d-flex align-items-center justify-content-center me-3" 
                                 style="width: 50px; height: 50px;">
                                <i class="fas fa-coins text-warning fa-lg"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">운용비용합계(W)</h6>
                                <h4 class="mb-0 text-warning">₩1,200,000</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-info bg-opacity-10 d-flex align-items-center justify-content-center me-3" 
                                 style="width: 50px; height: 50px;">
                                <i class="fas fa-chart-pie text-info fa-lg"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">Sub Total</h6>
                                <h4 class="mb-0 text-info">₩1,500,000</h4>
                                <small class="text-muted">판매 - 수취 - 운용</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commission Calculator -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent">
                        <h6 class="mb-0">
                            <i class="fas fa-calculator me-2"></i>수수료 자동 계산
                        </h6>
                    </div>
                    <div class="card-body">
                        <form id="commissionForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="receiptAmount" class="form-label">수취송금합계(W)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">₩</span>
                                        <input type="number" class="form-control" id="receiptAmount" 
                                               value="15500000" onchange="calculateCommission()">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="salesAmount" class="form-label">판매송금합계(W)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">₩</span>
                                        <input type="number" class="form-control" id="salesAmount" 
                                               value="18200000" onchange="calculateCommission()">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="operatingCost" class="form-label">운용비용합계(W)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">₩</span>
                                        <input type="number" class="form-control" id="operatingCost" 
                                               value="1200000" onchange="calculateCommission()">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="commissionRate" class="form-label">수수료율</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="commissionRate" 
                                               value="10" step="0.1" min="0" max="100" onchange="calculateCommission()">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <hr class="my-3">
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Sub Total</label>
                                    <div class="input-group">
                                        <span class="input-group-text">₩</span>
                                        <input type="text" class="form-control fw-bold text-primary" 
                                               id="subTotal" readonly>
                                    </div>
                                    <small class="text-muted">판매송금 - 수취송금 - 운용비용</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">수수료 금액</label>
                                    <div class="input-group">
                                        <span class="input-group-text">₩</span>
                                        <input type="text" class="form-control fw-bold text-success" 
                                               id="commissionAmount" readonly>
                                    </div>
                                    <small class="text-muted">Sub Total × 수수료율</small>
                                </div>
                            </div>
                        </form>
                        
                        <div class="d-flex gap-2 mt-3">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="resetCalculation()">
                                <i class="fas fa-undo me-1"></i>초기화
                            </button>
                            <button type="button" class="btn btn-primary btn-sm" onclick="saveCalculation()">
                                <i class="fas fa-save me-1"></i>저장
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent">
                        <h6 class="mb-0">
                            <i class="fas fa-receipt me-2"></i>관광영수증 출력
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="receiptRefNo" class="form-label">REF No</label>
                                <select class="form-select" id="receiptRefNo">
                                    <option value="">선택하세요</option>
                                    <option value="GF20240115001">GF20240115001 - 제주도 3박 4일</option>
                                    <option value="GF20240201002">GF20240201002 - 부산 2박 3일</option>
                                    <option value="GF20240220003">GF20240220003 - 서울 당일투어</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="receiptType" class="form-label">영수증 타입</label>
                                <select class="form-select" id="receiptType">
                                    <option value="standard">일반 영수증</option>
                                    <option value="detailed">상세 영수증</option>
                                    <option value="summary">요약 영수증</option>
                                </select>
                            </div>
                        </div>
                        
                        <hr class="my-3">
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-gf-primary" onclick="generateReceipt()">
                                <i class="fas fa-print me-2"></i>관광영수증 출력
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="previewReceipt()">
                                <i class="fas fa-eye me-2"></i>미리보기
                            </button>
                        </div>
                        
                        <!-- Quick Receipt Info -->
                        <div class="mt-3 p-3 bg-light rounded">
                            <h6 class="mb-2">영수증 정보</h6>
                            <div class="row g-2 text-sm">
                                <div class="col-4 text-muted">발행일:</div>
                                <div class="col-8" th:text="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}">날짜</div>
                                <div class="col-4 text-muted">발행자:</div>
                                <div class="col-8" sec:authentication="name">사용자명</div>
                                <div class="col-4 text-muted">회사:</div>
                                <div class="col-8">Good Feel Tour</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Reports Table -->
        <div class="row">
            <div class="col">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-table me-2"></i>정산 내역
                            </h6>
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="periodFilter" id="thisMonth" checked>
                                <label class="btn btn-outline-primary" for="thisMonth">이번 달</label>
                                <input type="radio" class="btn-check" name="periodFilter" id="lastMonth">
                                <label class="btn btn-outline-primary" for="lastMonth">지난 달</label>
                                <input type="radio" class="btn-check" name="periodFilter" id="thisYear">
                                <label class="btn btn-outline-primary" for="thisYear">올해</label>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th scope="col">REF No</th>
                                        <th scope="col">여행지</th>
                                        <th scope="col">수취송금(W)</th>
                                        <th scope="col">판매송금(W)</th>
                                        <th scope="col">운용비용(W)</th>
                                        <th scope="col">Sub Total</th>
                                        <th scope="col">수수료율</th>
                                        <th scope="col">수수료</th>
                                        <th scope="col">정산일</th>
                                        <th scope="col">관리</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Sample Financial Data -->
                                    <tr>
                                        <td><strong>GF20240115001</strong></td>
                                        <td>제주도 3박 4일</td>
                                        <td class="text-end">₩8,500,000</td>
                                        <td class="text-end">₩10,200,000</td>
                                        <td class="text-end">₩700,000</td>
                                        <td class="text-end fw-bold text-primary">₩1,000,000</td>
                                        <td class="text-center">10%</td>
                                        <td class="text-end fw-bold text-success">₩100,000</td>
                                        <td>2024.01.20</td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-primary" title="상세보기" 
                                                        onclick="viewFinancialDetail(1)">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-success" title="영수증 출력" 
                                                        onclick="printReceipt(1)">
                                                    <i class="fas fa-print"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-warning" title="수정" 
                                                        onclick="editFinancial(1)">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    
                                    <tr>
                                        <td><strong>GF20240201002</strong></td>
                                        <td>부산 2박 3일</td>
                                        <td class="text-end">₩4,200,000</td>
                                        <td class="text-end">₩5,100,000</td>
                                        <td class="text-end">₩350,000</td>
                                        <td class="text-end fw-bold text-primary">₩550,000</td>
                                        <td class="text-center">8%</td>
                                        <td class="text-end fw-bold text-success">₩44,000</td>
                                        <td>2024.02.05</td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-primary" title="상세보기" 
                                                        onclick="viewFinancialDetail(2)">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-success" title="영수증 출력" 
                                                        onclick="printReceipt(2)">
                                                    <i class="fas fa-print"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-warning" title="수정" 
                                                        onclick="editFinancial(2)">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td><strong>GF20240220003</strong></td>
                                        <td>서울 당일투어</td>
                                        <td class="text-end">₩2,800,000</td>
                                        <td class="text-end">₩2,900,000</td>
                                        <td class="text-end">₩150,000</td>
                                        <td class="text-end fw-bold text-primary">₩-50,000</td>
                                        <td class="text-center">-</td>
                                        <td class="text-end fw-bold text-danger">₩0</td>
                                        <td>-</td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-primary" title="상세보기" 
                                                        onclick="viewFinancialDetail(3)">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary disabled" title="영수증 출력">
                                                    <i class="fas fa-print"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-warning" title="수정" 
                                                        onclick="editFinancial(3)">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="row mt-4">
            <div class="col">
                <nav aria-label="페이지 네비게이션">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" aria-label="이전">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="다음">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Receipt Preview Modal -->
    <div class="modal fade" id="receiptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">관광영수증 미리보기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="receiptContent">
                    <!-- Receipt content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" onclick="printReceiptModal()">
                        <i class="fas fa-print me-2"></i>인쇄
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional JavaScript -->
    <script>
        // Calculate commission automatically
        function calculateCommission() {
            const receipt = parseInt(document.getElementById('receiptAmount').value) || 0;
            const sales = parseInt(document.getElementById('salesAmount').value) || 0;
            const operating = parseInt(document.getElementById('operatingCost').value) || 0;
            const rate = parseFloat(document.getElementById('commissionRate').value) || 0;
            
            // Sub Total = 판매송금합계 - 수취송금합계 - 운용비용합계
            const subTotal = sales - receipt - operating;
            const commission = Math.max(0, subTotal * rate / 100);
            
            document.getElementById('subTotal').value = subTotal.toLocaleString();
            document.getElementById('commissionAmount').value = Math.floor(commission).toLocaleString();
            
            // Update color based on sub total
            const subTotalInput = document.getElementById('subTotal');
            if (subTotal > 0) {
                subTotalInput.classList.remove('text-danger');
                subTotalInput.classList.add('text-primary');
            } else {
                subTotalInput.classList.remove('text-primary');
                subTotalInput.classList.add('text-danger');
            }
        }

        function resetCalculation() {
            document.getElementById('receiptAmount').value = '0';
            document.getElementById('salesAmount').value = '0';
            document.getElementById('operatingCost').value = '0';
            document.getElementById('commissionRate').value = '10';
            calculateCommission();
        }

        function saveCalculation() {
            console.log('Save calculation');
            alert('계산 결과가 저장되었습니다.');
        }

        function generateReceipt() {
            const refNo = document.getElementById('receiptRefNo').value;
            if (!refNo) {
                alert('REF No를 선택해주세요.');
                return;
            }
            
            console.log('Generate receipt for:', refNo);
            previewReceipt();
            setTimeout(() => {
                printReceiptModal();
            }, 500);
        }

        function previewReceipt() {
            const refNo = document.getElementById('receiptRefNo').value || 'GF20240115001';
            const receiptType = document.getElementById('receiptType').value;
            
            const receiptContent = `
                <div class="receipt-container">
                    <div class="text-center mb-4">
                        <h3 class="gf-secondary"><i class="fas fa-plane me-2"></i>Good Feel Tour</h3>
                        <h4>관광영수증</h4>
                        <p class="text-muted">Tourist Receipt</p>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>영수증 번호:</strong> ${refNo}<br>
                            <strong>발행일:</strong> ${new Date().toLocaleDateString('ko-KR')}<br>
                            <strong>담당자:</strong> 김담당
                        </div>
                        <div class="col-md-6 text-md-end">
                            <strong>여행사:</strong> Good Feel Tour<br>
                            <strong>연락처:</strong> 02-1234-5678<br>
                            <strong>주소:</strong> 서울시 강남구 테헤란로 123
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-4">
                        <h6>여행 정보</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>여행지:</strong> 제주도 3박 4일<br>
                                <strong>여행 기간:</strong> 2024.01.15 ~ 2024.01.18<br>
                                <strong>참가자 수:</strong> 15명
                            </div>
                            <div class="col-md-6">
                                <strong>가이드:</strong> 김가이드<br>
                                <strong>연락처:</strong> 010-1234-5678<br>
                                <strong>집합장소:</strong> 김포공항 3층 A 카운터
                            </div>
                        </div>
                    </div>
                    
                    <table class="table table-bordered">
                        <thead class="bg-light">
                            <tr>
                                <th>항목</th>
                                <th class="text-end">금액</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>수취송금합계(W)</td>
                                <td class="text-end">₩8,500,000</td>
                            </tr>
                            <tr>
                                <td>판매송금합계(W)</td>
                                <td class="text-end">₩10,200,000</td>
                            </tr>
                            <tr>
                                <td>운용비용합계(W)</td>
                                <td class="text-end">₩700,000</td>
                            </tr>
                            <tr class="table-primary">
                                <td><strong>Sub Total</strong></td>
                                <td class="text-end"><strong>₩1,000,000</strong></td>
                            </tr>
                            <tr>
                                <td>수수료 (10%)</td>
                                <td class="text-end">₩100,000</td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>최종 금액</strong></td>
                                <td class="text-end"><strong>₩900,000</strong></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="mt-4 text-center">
                        <p class="text-muted small">
                            본 영수증은 관광진흥법에 따라 발행되었습니다.<br>
                            문의사항이 있으시면 02-1234-5678로 연락해주세요.
                        </p>
                        <hr style="border: 2px solid #2E86AB; width: 100px; margin: 20px auto;">
                        <p class="text-muted small">Good Feel Tour - 좋은느낌여행사</p>
                    </div>
                </div>
            `;
            
            document.getElementById('receiptContent').innerHTML = receiptContent;
            const modal = new bootstrap.Modal(document.getElementById('receiptModal'));
            modal.show();
        }

        function printReceiptModal() {
            const content = document.getElementById('receiptContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>관광영수증</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
                        <style>
                            @media print {
                                body { margin: 0; }
                                .btn { display: none; }
                            }
                        </style>
                    </head>
                    <body class="p-4">
                        ${content}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Financial management functions
        window.viewFinancialDetail = function(id) {
            console.log('View financial detail:', id);
        };

        window.editFinancial = function(id) {
            console.log('Edit financial:', id);
        };

        window.printReceipt = function(id) {
            console.log('Print receipt for:', id);
            // Set the REF No and trigger receipt generation
            document.getElementById('receiptRefNo').selectedIndex = id;
            generateReceipt();
        };

        // Initialize calculation on page load
        document.addEventListener('DOMContentLoaded', function() {
            calculateCommission();
            
            // Export functionality
            document.getElementById('exportReport').addEventListener('click', function() {
                console.log('Export financial report to Excel');
                alert('Excel 파일이 다운로드됩니다.');
            });
        });
    </script>
</body>
</html>