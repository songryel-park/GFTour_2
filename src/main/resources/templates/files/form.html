<!DOCTYPE html>
<html lang="ko" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      th:replace="~{layout/base :: html}">
<head>
    <title>신규 등록 - Good Feel Tour</title>
</head>
<body>
    <div th:block="content">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="gf-secondary mb-0">
                            <i class="fas fa-plus me-2"></i>신규 등록
                        </h2>
                        <p class="text-muted mb-0">새로운 파일을 등록합니다. REF No는 자동으로 생성됩니다.</p>
                    </div>
                    <div>
                        <a th:href="@{/files}" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-list me-2"></i>목록으로
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Registration Form -->
        <form th:action="@{/files/new}" method="post" class="needs-validation" novalidate>
            <div class="row">
                <!-- Main Information -->
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-transparent">
                            <h6 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>기본 정보
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <!-- REF No (Auto-generated) -->
                                <div class="col-md-6">
                                    <label for="refNo" class="form-label">REF No</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="refNo" name="refNo" 
                                               value="GF20240101001" readonly>
                                        <button class="btn btn-outline-secondary" type="button" id="generateRefNo">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">REF No는 GF + YYYYMMDD + 3자리 순번으로 자동 생성됩니다.</div>
                                </div>

                                <!-- Destination -->
                                <div class="col-md-6">
                                    <label for="destination" class="form-label">여행지 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="destination" name="destination" 
                                           placeholder="예: 제주도 3박 4일" required>
                                    <div class="invalid-feedback">여행지를 입력해주세요.</div>
                                </div>

                                <!-- Manager -->
                                <div class="col-md-6">
                                    <label for="manager" class="form-label">담당자 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="manager" name="manager" 
                                           placeholder="담당자명" required>
                                    <div class="invalid-feedback">담당자를 입력해주세요.</div>
                                </div>

                                <!-- Agency -->
                                <div class="col-md-6">
                                    <label for="agency" class="form-label">여행사</label>
                                    <input type="text" class="form-control" id="agency" name="agency" 
                                           placeholder="여행사명 (선택사항)">
                                </div>

                                <!-- Travel Dates -->
                                <div class="col-md-6">
                                    <label for="travelStartDate" class="form-label">여행 시작일</label>
                                    <input type="datetime-local" class="form-control" id="travelStartDate" name="travelStartDate">
                                </div>

                                <div class="col-md-6">
                                    <label for="travelEndDate" class="form-label">여행 종료일</label>
                                    <input type="datetime-local" class="form-control" id="travelEndDate" name="travelEndDate">
                                </div>

                                <!-- Customer Count -->
                                <div class="col-md-6">
                                    <label for="customerCount" class="form-label">고객 수</label>
                                    <div class="input-group">
                                        <button class="btn btn-outline-secondary" type="button" id="decreaseCount">-</button>
                                        <input type="number" class="form-control text-center" id="customerCount" 
                                               name="customerCount" value="0" min="0" max="1000">
                                        <button class="btn btn-outline-secondary" type="button" id="increaseCount">+</button>
                                        <span class="input-group-text">명</span>
                                    </div>
                                </div>

                                <!-- Notes -->
                                <div class="col-12">
                                    <label for="notes" class="form-label">비고</label>
                                    <textarea class="form-control" id="notes" name="notes" rows="3" 
                                              placeholder="추가 정보나 특이사항을 입력하세요..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Information -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-transparent">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-users me-2"></i>고객 정보
                                </h6>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="addCustomer">
                                    <i class="fas fa-plus me-1"></i>고객 추가
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm" id="customerTable">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>이름 <span class="text-danger">*</span></th>
                                            <th>나이</th>
                                            <th>여권번호</th>
                                            <th>전화번호</th>
                                            <th>관리</th>
                                        </tr>
                                    </thead>
                                    <tbody id="customerList">
                                        <!-- Customer rows will be added dynamically -->
                                    </tbody>
                                </table>
                                <div id="noCustomers" class="text-center text-muted py-3">
                                    <i class="fas fa-user-plus fa-2x mb-2"></i>
                                    <p class="mb-0">고객을 추가해주세요.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Actions -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-transparent">
                            <h6 class="mb-0">
                                <i class="fas fa-cog me-2"></i>작업
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-gf-primary">
                                    <i class="fas fa-save me-2"></i>저장
                                </button>
                                <button type="button" class="btn btn-outline-warning" id="saveDraft">
                                    <i class="fas fa-file-alt me-2"></i>임시저장
                                </button>
                                <a th:href="@{/files}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-2"></i>취소
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- File Status -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-transparent">
                            <h6 class="mb-0">
                                <i class="fas fa-info me-2"></i>파일 정보
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2 text-sm">
                                <div class="col-4 text-muted">상태:</div>
                                <div class="col-8">
                                    <span class="badge bg-warning">신규</span>
                                </div>
                                <div class="col-4 text-muted">등록자:</div>
                                <div class="col-8" sec:authentication="name">사용자명</div>
                                <div class="col-4 text-muted">등록일:</div>
                                <div class="col-8" th:text="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd HH:mm')}">날짜</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent">
                            <h6 class="mb-0">
                                <i class="fas fa-bolt me-2"></i>빠른 작업
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" disabled>
                                    <i class="fas fa-file-invoice me-2"></i>견적서 생성
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" disabled>
                                    <i class="fas fa-calendar me-2"></i>일정 관리
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" disabled>
                                    <i class="fas fa-chart-line me-2"></i>정산 관리
                                </button>
                            </div>
                            <div class="form-text mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                파일 저장 후 이용 가능합니다.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Customer Modal -->
    <div class="modal fade" id="customerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">고객 정보 입력</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="customerForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="customerName" class="form-label">이름 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="customerName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="customerAge" class="form-label">나이</label>
                                <input type="number" class="form-control" id="customerAge" min="0" max="150">
                            </div>
                            <div class="col-md-6">
                                <label for="customerPassport" class="form-label">여권번호</label>
                                <input type="text" class="form-control" id="customerPassport" 
                                       placeholder="A12345678" maxlength="9">
                            </div>
                            <div class="col-md-6">
                                <label for="customerPhone" class="form-label">전화번호</label>
                                <input type="tel" class="form-control" id="customerPhone" 
                                       placeholder="010-1234-5678">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="saveCustomer">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let customerIndex = 0;

            // Customer count controls
            document.getElementById('decreaseCount').addEventListener('click', function() {
                const input = document.getElementById('customerCount');
                const currentValue = parseInt(input.value);
                if (currentValue > 0) {
                    input.value = currentValue - 1;
                }
            });

            document.getElementById('increaseCount').addEventListener('click', function() {
                const input = document.getElementById('customerCount');
                const currentValue = parseInt(input.value);
                if (currentValue < 1000) {
                    input.value = currentValue + 1;
                }
            });

            // REF No generation
            document.getElementById('generateRefNo').addEventListener('click', function() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const sequence = String(Math.floor(Math.random() * 999) + 1).padStart(3, '0');
                
                document.getElementById('refNo').value = `GF${year}${month}${day}${sequence}`;
            });

            // Customer management
            const customerModal = new bootstrap.Modal(document.getElementById('customerModal'));
            
            document.getElementById('addCustomer').addEventListener('click', function() {
                // Clear form
                document.getElementById('customerForm').reset();
                customerModal.show();
            });

            document.getElementById('saveCustomer').addEventListener('click', function() {
                const name = document.getElementById('customerName').value;
                const age = document.getElementById('customerAge').value;
                const passport = document.getElementById('customerPassport').value;
                const phone = document.getElementById('customerPhone').value;

                if (!name) {
                    alert('고객 이름을 입력해주세요.');
                    return;
                }

                addCustomerToTable(name, age, passport, phone);
                updateCustomerCount();
                customerModal.hide();
            });

            function addCustomerToTable(name, age, passport, phone) {
                const tbody = document.getElementById('customerList');
                const noCustomers = document.getElementById('noCustomers');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${name}</td>
                    <td>${age || '-'}</td>
                    <td>${passport || '-'}</td>
                    <td>${phone || '-'}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-customer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
                noCustomers.style.display = 'none';
                customerIndex++;

                // Add remove functionality
                row.querySelector('.remove-customer').addEventListener('click', function() {
                    row.remove();
                    updateCustomerCount();
                    
                    if (tbody.children.length === 0) {
                        noCustomers.style.display = 'block';
                    }
                });
            }

            function updateCustomerCount() {
                const count = document.getElementById('customerList').children.length;
                document.getElementById('customerCount').value = count;
            }

            // Form validation
            (function() {
                'use strict';
                const forms = document.querySelectorAll('.needs-validation');
                
                Array.prototype.slice.call(forms).forEach(function(form) {
                    form.addEventListener('submit', function(event) {
                        if (!form.checkValidity()) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            })();

            // Travel date validation
            document.getElementById('travelStartDate').addEventListener('change', function() {
                const startDate = this.value;
                const endDateInput = document.getElementById('travelEndDate');
                
                if (startDate) {
                    endDateInput.min = startDate;
                    if (endDateInput.value && endDateInput.value < startDate) {
                        endDateInput.value = startDate;
                    }
                }
            });
        });
    </script>
</body>
</html>